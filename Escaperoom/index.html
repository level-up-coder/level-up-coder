<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro:bit OS | Tactical Link</title>
    <style>
        :root { --neon-green: #00ff41; --bg-dark: #0d0d0d; --panel-bg: #1a1a1a; --danger: #ff3e3e; }
        body { font-family: 'Courier New', Courier, monospace; background-color: var(--bg-dark); color: var(--neon-green); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .container { width: 90%; max-width: 800px; background: var(--panel-bg); padding: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0, 255, 65, 0.2); border: 1px solid #333; }
        h1 { font-size: 1.5rem; text-transform: uppercase; letter-spacing: 3px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .timer-box { font-size: 3rem; color: var(--danger); text-align: center; margin: 20px 0; border: 2px solid var(--danger); padding: 10px; background: rgba(255, 62, 62, 0.1); display: none; }
        button { background: transparent; color: var(--neon-green); border: 1px solid var(--neon-green); padding: 10px 20px; font-family: inherit; cursor: pointer; transition: all 0.3s; margin: 5px; }
        button:hover { background: var(--neon-green); color: black; box-shadow: 0 0 15px var(--neon-green); }
        #console { background: #000; height: 250px; overflow-y: auto; border: 1px solid #333; padding: 15px; margin-top: 20px; font-size: 0.85rem; }
        .log-entry { margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Tactical Payload System</h1>
    <div id="status-bar">LINK_STATUS: <span id="status-text" style="color:var(--danger)">OFFLINE</span></div>
    
    <div id="timerDisplay" class="timer-box">T-MINUS: 20s</div>

    <button id="connectBtn">INITIALIZE LINK</button>
    <button id="startTimerBtn" style="display:none; border-color:var(--danger); color:var(--danger)">ARM PAYLOAD</button>

    <div id="console">
        <div class="log-entry">Waiting for hardware connection...</div>
    </div>
</div>

<script>
    const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const RX_CHARACTERISTIC = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';
    
    let rxChar, timerInterval;
    let timeLeft = 20;

    function log(msg, color = '#888') {
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `<span style="color: ${color}">> ${msg}</span>`;
        document.getElementById('console').appendChild(entry);
        document.getElementById('console').scrollTop = document.getElementById('console').scrollHeight;
    }

    document.getElementById('connectBtn').onclick = async () => {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'BBC micro:bit' }],
                optionalServices: [SERVICE_UUID]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);
            rxChar = await service.getCharacteristic(RX_CHARACTERISTIC);
            
            document.getElementById('status-text').innerText = "ONLINE";
            document.getElementById('status-text').style.color = "var(--neon-green)";
            document.getElementById('startTimerBtn').style.display = "inline-block";
            log("Secure link established. Payload ready for arming.", "var(--neon-green)");
        } catch (e) { log("CONNECTION_FAILED: " + e.message, "var(--danger)"); }
    };

    document.getElementById('startTimerBtn').onclick = () => {
        document.getElementById('timerDisplay').style.display = "block";
        log("PAYLOAD ARMED. 20 SECOND COUNTDOWN INITIATED.", "var(--danger)");
        
        timerInterval = setInterval(async () => {
            timeLeft--;
            document.getElementById('timerDisplay').innerText = `T-MINUS: ${timeLeft}s`;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                log("TIME EXPIRED. SENDING DETONATION SIGNAL...", "var(--danger)");
                const encoder = new TextEncoder();
                // We send the keyword "BOOM" to the micro:bit
                await rxChar.writeValue(encoder.encode("BOOM\n"));
                document.getElementById('timerDisplay').innerText = "PAYLOAD DELIVERED";
            }
        }, 1000);
    };
</script>
</body>
</html>